datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id           String        @id @default(cuid())
  email        String        @unique
  name         String?
  password     String?       // Hashed password for credentials auth
  role         String        @default("LEARNER") // ADMIN | INSTRUCTOR | LEARNER
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  enrollments  Enrollment[]
  certificates Certificate[]
  payments     Payment[]
}

model Course {
  id           String        @id @default(cuid())
  title        String
  description  String
  priceCents   Int
  active       Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  sessions     Session[]
  enrollments  Enrollment[]
  certificates Certificate[]
  payments     Payment[]
  files        File[]
}

model Session {
  id           String   @id @default(cuid())
  courseId     String
  startsAt     DateTime
  endsAt       DateTime
  location     String?
  instructorId String?
  createdAt    DateTime @default(now())
  course       Course   @relation(fields: [courseId], references: [id])
}

model Enrollment {
  id           String        @id @default(cuid())
  userId       String
  courseId     String
  status       String        @default("assigned") // assigned | attended | completed
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  user         User          @relation(fields: [userId], references: [id])
  course       Course        @relation(fields: [courseId], references: [id])
  certificates Certificate[]

  @@unique([userId, courseId], name: "userId_courseId")
}

model Certificate {
  id           String     @id @default(cuid())
  userId       String
  courseId     String
  enrollmentId String
  issuedAt     DateTime   @default(now())
  pdfKey       String
  pdfUrl       String
  user         User       @relation(fields: [userId], references: [id])
  course       Course     @relation(fields: [courseId], references: [id])
  enrollment   Enrollment @relation(fields: [enrollmentId], references: [id])
}

model Payment {
  id              String   @id @default(cuid())
  userId          String?
  courseId        String?
  stripeSessionId String   @unique
  amountCents     Int
  status          String // paid | refunded | failed
  email           String?
  groupSize       Int?
  discountApplied Boolean  @default(false)
  createdAt       DateTime @default(now())
  user            User?    @relation(fields: [userId], references: [id])
  course          Course?  @relation(fields: [courseId], references: [id])
}

model File {
  id          String   @id @default(cuid())
  type        String // HOMEWORK | ROSTER | DOC
  courseId    String?
  fileName    String
  storageKey  String // blob pathname, e.g., homework/COURSE/...
  url         String // blob.url (public)
  downloadUrl String // blob.downloadUrl (public download)
  uploadedBy  String
  createdAt   DateTime @default(now())
  course      Course?  @relation(fields: [courseId], references: [id])
}

model AuditLog {
  id         String   @id @default(cuid())
  actorId    String
  action     String
  targetType String
  targetId   String
  meta       Json?
  createdAt  DateTime @default(now())
}
